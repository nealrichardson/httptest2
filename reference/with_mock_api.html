<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Serve a mock API from files — with_mock_api • httptest2</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Serve a mock API from files — with_mock_api"><meta property="og:description" content="In this context, HTTP requests attempt to load API response fixtures from
files. This allows test code to proceed evaluating code that expects
HTTP requests to return meaningful responses. Requests that do not have a
corresponding fixture file raise errors, like how without_internet()
does."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-104182925-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-104182925-1');
</script></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">httptest2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/httptest2.html">Get Started</a>
</li>
<li>
  <a href="../reference/">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/httptest2.html">Overview</a>
    </li>
    <li>
      <a href="../articles/redacting.html">Redacting Sensitive Information</a>
    </li>
    <li>
      <a href="../articles/vignettes.html">Using with Vignettes</a>
    </li>
    <li>
      <a href="../articles/faq.html">FAQ</a>
    </li>
  </ul></li>
<li>
  <a href="../news/">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/nealrichardson/httptest2" class="external-link">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
<li>
  <a href="https://enpiar.com" class="external-link">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Serve a mock API from files</h1>
    <small class="dont-index">Source: <a href="https://github.com/nealrichardson/httptest2/blob/1.2.0/R/mock-api.R" class="external-link"><code>R/mock-api.R</code></a></small>
    <div class="hidden name"><code>with_mock_api.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>In this context, HTTP requests attempt to load API response fixtures from
files. This allows test code to proceed evaluating code that expects
HTTP requests to return meaningful responses. Requests that do not have a
corresponding fixture file raise errors, like how <code><a href="without_internet.html">without_internet()</a></code>
does.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">with_mock_api</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">use_mock_api</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">stop_mocking</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>Code to run inside the mock context</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p><code>with_mock_api()</code> returns the result of <code>expr</code>. <code>use_mock_api()</code> and
<code>stop_mocking()</code> return nothing.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p><code>use_mock_api()</code> and <code>stop_mocking()</code> allow you to turn on/off request
mocking for more convenient use in an interactive session.</p>
<p>Requests are translated to mock file paths according to several rules that
incorporate the request method, URL, query parameters, and body. See
<code><a href="build_mock_url.html">build_mock_url()</a></code> for details.</p>
<p>File paths for API fixture files may be relative to the 'tests/testthat'
directory, i.e. relative to the .R test files themselves. This is the default
location for storing and retrieving mocks, but you can put them anywhere you
want as long as you set the appropriate location with <code><a href="mockPaths.html">.mockPaths()</a></code>.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org" class="external-link">httr2</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">with_mock_api</span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># There are no mocks recorded in this example, so catch this request with</span></span></span>
<span class="r-in"><span>  <span class="co"># expect_GET()</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="expect_verb.html">expect_GET</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="st">"https://cran.r-project.org"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    <span class="st">"https://cran.r-project.org"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># For examples with mocks, see the tests and vignettes</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB; font-weight: bold;">&lt;error/httptest2_request&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in </span><span style="color: #5555FF; font-weight: bold;">`stop_request()`</span><span style="font-weight: bold;">:</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BBBB00;">!</span> An unexpected request was made:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GET https://cran.r-project.org</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Expected mock file: cran.r-project.org.*</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="font-weight: bold;">Backtrace:</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">     </span>▆</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  1. </span>├─<span style="font-weight: bold;">pkgdown</span>::deploy_to_branch(new_process = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  2. </span>│ <span style="color: #949494;">└─pkgdown::build_site_github_pages(pkg, ..., clean = clean)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  3. </span>│   <span style="color: #949494;">└─pkgdown::build_site(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  4. </span>│     <span style="color: #949494;">└─pkgdown:::build_site_local(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  5. </span>│       <span style="color: #949494;">└─pkgdown::build_reference(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  6. </span>│         <span style="color: #949494;">├─pkgdown:::unwrap_purrr_error(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  7. </span>│         <span style="color: #949494;">│ └─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::withCallingHandlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  8. </span>│         <span style="color: #949494;">└─</span><span style="color: #949494; font-weight: bold;">purrr</span><span style="color: #949494;">::map(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">  9. </span>│           <span style="color: #949494;">└─purrr:::map_("list", .x, .f, ..., .progress = .progress)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 10. </span>│             <span style="color: #949494;">├─purrr:::with_indexed_errors(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 11. </span>│             <span style="color: #949494;">│ └─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::withCallingHandlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 12. </span>│             <span style="color: #949494;">├─</span><span style="color: #949494; font-weight: bold;">purrr</span><span style="color: #949494;">:::call_with_cleanup(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 13. </span>│             <span style="color: #949494;">└─</span><span style="color: #949494; font-weight: bold;">pkgdown</span><span style="color: #949494;"> (local) .f(.x[[i]], ...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 14. </span>│               <span style="color: #949494;">├─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::withCallingHandlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 15. </span>│               <span style="color: #949494;">└─</span><span style="color: #949494; font-weight: bold;">pkgdown</span><span style="color: #949494;">:::data_reference_topic(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 16. </span>│                 <span style="color: #949494;">└─pkgdown:::run_examples(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 17. </span>│                   <span style="color: #949494;">└─pkgdown:::highlight_examples(code, topic, env = env)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 18. </span>│                     <span style="color: #949494;">└─</span><span style="color: #949494; font-weight: bold;">downlit</span><span style="color: #949494;">::evaluate_and_highlight(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 19. </span>│                       <span style="color: #949494;">└─</span><span style="color: #949494; font-weight: bold;">evaluate</span><span style="color: #949494;">::evaluate(code, child_env(env), new_device = TRUE, output_handler = output_handler)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 20. </span>│                         <span style="color: #949494;">├─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::withRestarts(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 21. </span>│                         <span style="color: #949494;">│ └─base (local) withRestartList(expr, restarts)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 22. </span>│                         <span style="color: #949494;">│   ├─base (local) withOneRestart(withRestartList(expr, restarts[-nr]), restarts[[nr]])</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 23. </span>│                         <span style="color: #949494;">│   │ └─base (local) doWithOneRestart(return(expr), restart)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 24. </span>│                         <span style="color: #949494;">│   └─base (local) withRestartList(expr, restarts[-nr])</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 25. </span>│                         <span style="color: #949494;">│     └─base (local) withOneRestart(expr, restarts[[1L]])</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 26. </span>│                         <span style="color: #949494;">│       └─base (local) doWithOneRestart(return(expr), restart)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 27. </span>│                         <span style="color: #949494;">├─</span><span style="color: #949494; font-weight: bold;">evaluate</span><span style="color: #949494;">:::with_handlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 28. </span>│                         <span style="color: #949494;">│ ├─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::eval(call)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 29. </span>│                         <span style="color: #949494;">│ │ └─base::eval(call)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 30. </span>│                         <span style="color: #949494;">│ └─base::withCallingHandlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 31. </span>│                         <span style="color: #949494;">├─base::withVisible(eval(expr, envir))</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 32. </span>│                         <span style="color: #949494;">└─base::eval(expr, envir)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 33. </span>│                           <span style="color: #949494;">└─base::eval(expr, envir)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 34. </span>│                             <span style="color: #949494;">├─httptest2::with_mock_api(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 35. </span>│                             <span style="color: #949494;">│ └─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::eval.parent(expr)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 36. </span>│                             <span style="color: #949494;">│   └─base::eval(expr, p)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 37. </span>│                             <span style="color: #949494;">├─httptest2::expect_GET(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 38. </span>│                             <span style="color: #949494;">│ └─httptest2:::expect_request(object, "GET ", url, " ", ...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 39. </span>│                             <span style="color: #949494;">│   ├─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::withCallingHandlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 40. </span>│                             <span style="color: #949494;">│   └─</span><span style="color: #949494; font-weight: bold;">testthat</span><span style="color: #949494;">::expect_error(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 41. </span>│                             <span style="color: #949494;">│     └─testthat:::quasi_capture(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 42. </span>│                             <span style="color: #949494;">│       ├─testthat (local) .capture(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 43. </span>│                             <span style="color: #949494;">│       │ └─</span><span style="color: #949494; font-weight: bold;">base</span><span style="color: #949494;">::withCallingHandlers(...)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 44. </span>│                             <span style="color: #949494;">│       └─</span><span style="color: #949494; font-weight: bold;">rlang</span><span style="color: #949494;">::eval_bare(quo_get_expr(.quo), quo_get_env(.quo))</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 45. </span>│                             <span style="color: #949494;">└─request("https://cran.r-project.org") %&gt;% req_perform()</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 46. </span>└─httr2::req_perform(.)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 47. </span>  └─httptest2 (local) mock(req)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #555555;"> 48. </span>    └─<span style="color: #5555FF; font-weight: bold;">httptest2:::stop_request(</span>req<span style="color: #5555FF; font-weight: bold;">)</span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Neal Richardson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer></div>






  </body></html>

